name: DEBUG - Docker Hub API Access Test

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  debug-access:
    name: Test Docker Hub API Access
    runs-on: ubuntu-latest

    steps:
      - name: Test 1 - Login to Docker Hub API
        run: |
          echo "================================"
          echo "TEST 1: Docker Hub Login"
          echo "================================"

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\": \"${{ secrets.DOCKERHUB_USERNAME }}\", \"password\": \"${{ secrets.DOCKERHUB_TOKEN }}\"}" \
            https://hub.docker.com/v2/users/login/)

          echo "Login Response:"
          echo "$RESPONSE" | jq .

          TOKEN=$(echo "$RESPONSE" | jq -r .token)

          if [ "$TOKEN" != "null" ] && [ -n "$TOKEN" ]; then
            echo "✅ Login successful! Token acquired."
            echo "TOKEN_ACQUIRED=true" >> $GITHUB_ENV
            echo "DOCKER_JWT=$TOKEN" >> $GITHUB_ENV
          else
            echo "❌ Login failed!"
            echo "TOKEN_ACQUIRED=false" >> $GITHUB_ENV
          fi

      - name: Test 2 - Get Repository Info
        if: env.TOKEN_ACQUIRED == 'true'
        run: |
          echo "================================"
          echo "TEST 2: Get Repository Info"
          echo "================================"

          for REPO in dockerdiscordcontrol dockerdiscordcontrol-mac dockerdiscordcontrol-linux dockerdiscordcontrol-windows; do
            echo ""
            echo "Testing: dockerdiscordcontrol/$REPO"
            echo "---"

            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -H "Authorization: JWT ${{ env.DOCKER_JWT }}" \
              https://hub.docker.com/v2/repositories/dockerdiscordcontrol/$REPO/)

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

            echo "HTTP Status: $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Repository accessible"
              echo "Owner: $(echo "$BODY" | jq -r .user)"
              echo "Namespace: $(echo "$BODY" | jq -r .namespace)"
              echo "Is Private: $(echo "$BODY" | jq -r .is_private)"
            else
              echo "❌ Repository NOT accessible"
              echo "Response: $BODY"
            fi
          done

      - name: Test 3 - Try PATCH Request (Dry Run)
        if: env.TOKEN_ACQUIRED == 'true'
        run: |
          echo "================================"
          echo "TEST 3: Test PATCH Permission"
          echo "================================"

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X PATCH \
            -H "Authorization: JWT ${{ env.DOCKER_JWT }}" \
            -H "Content-Type: application/json" \
            -d '{"full_description": "Test description update"}' \
            https://hub.docker.com/v2/repositories/dockerdiscordcontrol/dockerdiscordcontrol-windows/)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body:"
          echo "$BODY" | jq . || echo "$BODY"

          case $HTTP_CODE in
            200|204)
              echo "✅ PATCH successful - Token has WRITE permission!"
              ;;
            401)
              echo "❌ Unauthorized - Token invalid or expired"
              ;;
            403)
              echo "❌ Forbidden - Token lacks WRITE permission for this repository"
              echo ""
              echo "Possible causes:"
              echo "1. Repository owner is different from token owner"
              echo "2. Token doesn't have 'Read, Write, Delete' permissions"
              echo "3. Repository is under an organization that token can't access"
              ;;
            404)
              echo "❌ Not Found - Repository doesn't exist"
              ;;
            *)
              echo "❌ Unknown error (HTTP $HTTP_CODE)"
              ;;
          esac

      - name: Test 4 - Check Token Permissions
        if: env.TOKEN_ACQUIRED == 'true'
        run: |
          echo "================================"
          echo "TEST 4: Token Info"
          echo "================================"

          # Decode JWT token to see permissions (without verification)
          JWT_PAYLOAD=$(echo "${{ env.DOCKER_JWT }}" | cut -d. -f2)
          # Add padding if needed
          JWT_PAYLOAD=$(echo "$JWT_PAYLOAD" | sed 's/-/+/g; s/_/\//g')

          echo "Token Payload (decoded):"
          echo "$JWT_PAYLOAD" | base64 -d 2>/dev/null | jq . || echo "Could not decode token"

      - name: Summary
        if: always()
        run: |
          echo "================================"
          echo "SUMMARY"
          echo "================================"
          echo ""
          echo "Username: ${{ secrets.DOCKERHUB_USERNAME }}"
          echo "Token Acquired: ${{ env.TOKEN_ACQUIRED }}"
          echo ""
          echo "Check the logs above to see:"
          echo "1. If login succeeded"
          echo "2. Which repositories are accessible"
          echo "3. What error PATCH returns"
          echo "4. Token permissions"
